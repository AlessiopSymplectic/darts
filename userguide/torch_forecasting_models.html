
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>In-depth look at Torch Forecasting Models &#8212; darts  documentation</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/blank.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../_static/docs-favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Neural Networks Performance Recommendations" href="performance.html" />
    <link rel="prev" title="User Guide" href="../userguide.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/darts-logo-trim.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../README.html">
  Home
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../quickstart/00-quickstart.html">
  Quickstart
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../userguide.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../generated_api/darts.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../examples.html">
  Examples
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/unit8co/darts" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/unit8co" rel="noopener" target="_blank" title="Twitter">
            <span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   In-depth look at Torch Forecasting Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="performance.html">
   Neural Networks Performance Recommendations
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="covariates.html">
   Darts Covariates
  </a>
 </li>
</ul>

  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#content-of-this-document">
   Content of this document
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   1.1. Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#top-level-look-at-training-and-predicting-with-chunks">
   1.2. Top level look at training and predicting with chunks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#torch-forecasting-model-covariates-support">
   1.3. Torch Forecasting Model Covariates Support
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#required-target-time-spans-for-training-validation-and-prediction">
   1.4. Required target time spans for training, validation and prediction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#in-depth-look-at-how-input-data-is-used-when-training-and-predicting-with-tfms">
   2. In-depth look at how input data is used when training and predicting with TFMs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#training">
   2.1. Training
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#training-with-a-validation-dataset">
     2.1.1. Training with a validation dataset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#saving-and-loading-model-states">
     2.1.2. Saving and Loading Model States
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#forecast-prediction">
   2.2. Forecast/Prediction
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="in-depth-look-at-torch-forecasting-models">
<h1>In-depth look at Torch Forecasting Models<a class="headerlink" href="#in-depth-look-at-torch-forecasting-models" title="Permalink to this headline">¶</a></h1>
<p>This document was written for darts version 0.15.0.</p>
<p>We assume that you already know about covariates in Darts. If you’re new to the topic we recommend you to read our <a class="reference external" href="https://unit8co.github.io/darts/userguide/covariates.html">guide on covariates</a> first.</p>
<section id="content-of-this-document">
<h2>Content of this document<a class="headerlink" href="#content-of-this-document" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="#11-introduction">Section 1</a> covers the most important points about Torch Forecasting Models (TFMs):</p>
<ul class="simple">
<li><p>How to use TFMs</p></li>
<li><p>Top-level look at chunks</p></li>
<li><p>TFM covariates support</p></li>
<li><p>Time span requirements for target and covariate series</p></li>
</ul>
<p><a class="reference external" href="#2-in-depth-look-at-how-input-data-is-used-when-training-and-predicting-with-tfms">Section 2</a> gives
an in-depth guide of how input data is used when training and predicting with TFMs.</p>
</section>
<section id="introduction">
<h2>1.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>In Darts, <strong>Torch Forecasting Models (TFMs)</strong> are broadly speaking “machine learning based” models, which denote PyTorch-based (deep learning) models.</p>
<p>TFMs train and predict on fixed-length chunks (sub-samples) of your input <code class="docutils literal notranslate"><span class="pre">target</span></code> and <code class="docutils literal notranslate"><span class="pre">*_covariates</span></code> series (if supported). <code class="docutils literal notranslate"><span class="pre">Target</span></code> is the series for which we want to predict the future, <code class="docutils literal notranslate"><span class="pre">*_covariates</span></code> are the past and / or future covariates.</p>
<p>Each chunk contains an input chunk - representing the sample’s past - and an output chunk - the sample’s future. The sample’s prediction point lies at the end of the input chunk. The length of these chunks has to be specified at model creation with parameters <code class="docutils literal notranslate"><span class="pre">input_chunk_length</span></code> and <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code> (more on chunks in <a class="reference external" href="#12-top-level-look-at-training-and-predicting-with-chunks">section 1.2.</a>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># model that looks 7 time steps back (past) and 1 time step ahead (future)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">SomeTorchForecastingModel</span><span class="p">(</span><span class="n">input_chunk_length</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                                  <span class="n">output_chunk_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>All TFMs can be trained on single or multiple <code class="docutils literal notranslate"><span class="pre">target</span></code> series and, depending on their covariate support (covered in <a class="reference external" href="#13-torch-forecasting-model-covariates-support">section 1.3.</a>), <code class="docutils literal notranslate"><span class="pre">past_covariates</span></code> and / or <code class="docutils literal notranslate"><span class="pre">future_covariates</span></code>. When using covariates you have to supply one dedicated past and / or future covariates series for each target series.</p>
<p>Optionally, you can use a validation set with dedicated covariates during training. If the covariates have the required time spans, you can use the same for training, validation and prediction. (covered in <a class="reference external" href="#14-required-target-time-spans-for-training-validation-and-prediction">section 1.4.</a>)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># fit the model on a single target series with optional past and / or future covariates</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">target</span><span class="p">,</span>
          <span class="n">past_covariates</span><span class="o">=</span><span class="n">past_covariates</span><span class="p">,</span>
          <span class="n">future_covariates</span><span class="o">=</span><span class="n">future_covariates</span><span class="p">,</span>
          <span class="n">val_series</span><span class="o">=</span><span class="n">target_val</span><span class="p">,</span>  <span class="c1"># optionally, use a validation set</span>
          <span class="n">val_past_covariates</span><span class="o">=</span><span class="n">past_covariates_val</span><span class="p">,</span>
          <span class="n">val_future_covariates</span><span class="o">=</span><span class="n">future_covariates_val</span><span class="p">)</span>

<span class="c1"># fit the model on multiple target series</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">([</span><span class="n">target</span><span class="p">,</span> <span class="n">target2</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
          <span class="n">past_covariates</span><span class="o">=</span><span class="p">[</span><span class="n">past_covariates</span><span class="p">,</span> <span class="n">past_covariates2</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
          <span class="o">...</span>
          <span class="p">)</span>
</pre></div>
</div>
<p>You can produce forecasts for any input <code class="docutils literal notranslate"><span class="pre">target</span></code> TimeSeries or for several targets given as a sequence of TimeSeries. This will also work on series that have not been seen during training, as long as each series contains at least <code class="docutils literal notranslate"><span class="pre">input_chunk_length</span></code> time steps.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># predict the next n=3 time steps for any input series with `series`</span>
<span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                           <span class="n">series</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
                           <span class="n">past_covariates</span><span class="o">=</span><span class="n">past_covariates</span><span class="p">,</span>
                           <span class="n">future_covariates</span><span class="o">=</span><span class="n">future_covariates</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to know more about the training and prediction process of our Torch Forecasting Models and how they work with covariates, read on.</p>
</section>
<section id="top-level-look-at-training-and-predicting-with-chunks">
<h2>1.2. Top level look at training and predicting with chunks<a class="headerlink" href="#top-level-look-at-training-and-predicting-with-chunks" title="Permalink to this headline">¶</a></h2>
<p>In Figure 1 you can see how your data is distributed to the input and output chunks for each sample when calling <code class="docutils literal notranslate"><span class="pre">fit()</span></code> or <code class="docutils literal notranslate"><span class="pre">predict()</span></code>. For this example we look at data with daily frequency. The input chunk extracts values from <code class="docutils literal notranslate"><span class="pre">target</span></code> and optionally from <code class="docutils literal notranslate"><span class="pre">past_covariates</span></code> and / or <code class="docutils literal notranslate"><span class="pre">future_covariates</span></code> that fall into the input chunk time span. These “past” values of <code class="docutils literal notranslate"><span class="pre">future_covariates</span></code> are called “historic future covariates”.</p>
<p>The output chunk only takes optional <code class="docutils literal notranslate"><span class="pre">future_covariates</span></code> values that fall into the output chunk time span. The future values of our <code class="docutils literal notranslate"><span class="pre">past_covariates</span></code> - “future past covariates” - are only used to provide the input chunk of upcoming samples with new data.</p>
<p>All this information is used to predict the “future target” - the next <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code> points after the end of “past target”.</p>
<a class="reference external image-reference" href="./images/covariates/tfm.png"><img alt="figure0" src="../_images/tfm.png" /></a>
<p><strong>Figure 1: Top level look at training / predicting on chunks with Torch Forecasting Models</strong></p>
<p>When calling <code class="docutils literal notranslate"><span class="pre">predict()</span></code> and depending on your forecast horizon <code class="docutils literal notranslate"><span class="pre">n</span></code>, the model can either predict in one go (if <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&lt;=</span> <span class="pre">output_chunk_length</span></code>), or auto-regressively, by predicting on multiple chunks in the future (if <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&gt;</span> <span class="pre">output_chunk_length</span></code>). That is the reason why when predicting with <code class="docutils literal notranslate"><span class="pre">past_covariates</span></code> you might have to supply additional “future values of your <code class="docutils literal notranslate"><span class="pre">past_covariates</span></code>“.</p>
</section>
<section id="torch-forecasting-model-covariates-support">
<h2>1.3. Torch Forecasting Model Covariates Support<a class="headerlink" href="#torch-forecasting-model-covariates-support" title="Permalink to this headline">¶</a></h2>
<p>Under the hood, Darts has 5 types of <code class="docutils literal notranslate"><span class="pre">{X}CovariatesModel</span></code> classes implemented to cover different combinations of the covariate types mentioned before:</p>
<table class="table">
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Class</p></th>
<th class="head"><p>past covariates</p></th>
<th class="head"><p>future past covariates</p></th>
<th class="head"><p>future covariates</p></th>
<th class="head"><p>historic future covariates</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">PastCovariatesModel</span></code></p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">FutureCovariatesModel</span></code></p></td>
<td></td>
<td></td>
<td><p>✅</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DualCovariatesModel</span></code></p></td>
<td></td>
<td></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">MixedCovariatesModel</span></code></p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SplitCovariatesModel</span></code></p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>Table 1: Darts’ “{X}CovariatesModels” covariate support</strong></p>
<p>Each Torch Forecasting Model inherits from one <code class="docutils literal notranslate"><span class="pre">{X}CovariatesModel</span></code> (covariate class names are abbreviated by the <code class="docutils literal notranslate"><span class="pre">X</span></code>-part):</p>
<table class="table">
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>TFM</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">Past</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">Future</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">Dual</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">Mixed</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">Split</span></code></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">RNNModel</span></code></p></td>
<td></td>
<td></td>
<td><p>✅</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">BlockRNNModel</span></code></p></td>
<td><p>✅</p></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">NBEATSModel</span></code></p></td>
<td><p>✅</p></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">TCNModel</span></code></p></td>
<td><p>✅</p></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">TransformerModel</span></code></p></td>
<td><p>✅</p></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">TFTModel</span></code></p></td>
<td></td>
<td></td>
<td></td>
<td><p>✅</p></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>Table 2: Darts’ Torch Forecasting Model covariate support</strong></p>
</section>
<section id="required-target-time-spans-for-training-validation-and-prediction">
<h2>1.4. Required target time spans for training, validation and prediction<a class="headerlink" href="#required-target-time-spans-for-training-validation-and-prediction" title="Permalink to this headline">¶</a></h2>
<p>The relevant data is extracted automatically by the models, based on the time axes of the series.
You can use the same covariates series for both <code class="docutils literal notranslate"><span class="pre">fit()</span></code> and <code class="docutils literal notranslate"><span class="pre">predict()</span></code> if they meet the requirements below.</p>
<p><strong>Training</strong> only works if at least one sample with an input and output chunk can be extracted from the data you passed to <code class="docutils literal notranslate"><span class="pre">fit()</span></code>. This applies both to training and validation data. In terms of minimum required time spans, this means:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">target</span></code> series of minimum length <code class="docutils literal notranslate"><span class="pre">input_chunk_length</span> <span class="pre">+</span> <span class="pre">output_chunk_length</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">*_covariates</span></code> time span requirements for <code class="docutils literal notranslate"><span class="pre">fit()</span></code> from <a class="reference external" href="https://unit8co.github.io/darts/userguide/covariates.html#id6">covariates guide section 2.3.</a></p></li>
</ul>
<p>For <strong>prediction</strong> you have to supply the <code class="docutils literal notranslate"><span class="pre">target</span></code> series that you wish to forecast. For any forecast horizon <code class="docutils literal notranslate"><span class="pre">n</span></code> the minimum time span requirements are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">target</span></code> series of minimum length <code class="docutils literal notranslate"><span class="pre">input_chunk_length</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">*_covariates</span></code> time span requirements for <code class="docutils literal notranslate"><span class="pre">predict()</span></code> also from from <a class="reference external" href="https://unit8co.github.io/darts/userguide/covariates.html#id6">covariates guide section 2.3.</a></p></li>
</ul>
<p>Side note: Our <code class="docutils literal notranslate"><span class="pre">*RNNModels</span></code> accept a <code class="docutils literal notranslate"><span class="pre">training_length</span></code> parameter at model creation instead of <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code>. Internally the <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code> for these models is automatically set to <code class="docutils literal notranslate"><span class="pre">1</span></code>. For training, past <code class="docutils literal notranslate"><span class="pre">target</span></code> must have a minimum length of <code class="docutils literal notranslate"><span class="pre">training_length</span> <span class="pre">+</span> <span class="pre">1</span></code> and for prediction, a length of <code class="docutils literal notranslate"><span class="pre">input_chunk_length</span></code>.</p>
</section>
<section id="in-depth-look-at-how-input-data-is-used-when-training-and-predicting-with-tfms">
<h2>2. In-depth look at how input data is used when training and predicting with TFMs<a class="headerlink" href="#in-depth-look-at-how-input-data-is-used-when-training-and-predicting-with-tfms" title="Permalink to this headline">¶</a></h2>
</section>
<section id="training">
<h2>2.1. Training<a class="headerlink" href="#training" title="Permalink to this headline">¶</a></h2>
<p>Let’s have a look at how the models work under the hood.</p>
<p>Let’s assume we run an ice-cream shop and we want to predict sales for the next day.
We have one year (365 days) past data of our end-of-day ice-cream sales and of the average measured daily ambient temperature.
We also noticed that our ice-cream sales depend on the day of the week so we want to include this in our model.</p>
<ul class="simple">
<li><p>past target: actual past ice-cream sales <code class="docutils literal notranslate"><span class="pre">ice_cream_sales</span></code></p></li>
<li><p>future target: predict the ice-cream sales for the next day</p></li>
<li><p>past covariates: measured average daily temperatures in the past <code class="docutils literal notranslate"><span class="pre">temperature</span></code></p></li>
<li><p>future covariates: day of the week for past and future <code class="docutils literal notranslate"><span class="pre">weekday</span></code></p></li>
</ul>
<p>Checking Table 1, a model that would accomodate this kind of covariates would be a
<code class="docutils literal notranslate"><span class="pre">SplitCovariatesModel</span></code> (if we don’t use historic values of future covariates), or
<code class="docutils literal notranslate"><span class="pre">MixedCovariatesModel</span></code> (if we do). We choose a <code class="docutils literal notranslate"><span class="pre">MixedCovariatesModel</span></code> - the <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code>.</p>
<p>Imagine that we saw a pattern in our past ice cream sales that repeated week after week.
So we set <code class="docutils literal notranslate"><span class="pre">input_chunk_length</span> <span class="pre">=</span> <span class="pre">7</span></code> days to let the model look back an entire week into the past.
The <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code> can be set to <code class="docutils literal notranslate"><span class="pre">1</span></code> day to predict the next day.</p>
<p>Now we can create a model and train it! Figure 2 shows you how <code class="docutils literal notranslate"><span class="pre">TFTModel</span></code> will use our data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">darts.models</span> <span class="kn">import</span> <span class="n">TFTModel</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">TFTModel</span><span class="p">(</span><span class="n">input_chunk_length</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">output_chunk_length</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">ice_cream_sales</span><span class="p">,</span>
          <span class="n">past_covariates</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
          <span class="n">future_covariates</span><span class="o">=</span><span class="n">weekday</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference external image-reference" href="./images/covariates/seq_covs_single.png"><img alt="figure4" src="../_images/seq_covs_single.png" /></a>
<p><strong>Figure 2: Overview of a single sequence from our ice-cream sales example</strong>; Mon1 - Sun1 stand for the first 7 days from our training dataset (week 1 of the year). Mon2 is the Monday of week 2.</p>
<p>When calling <code class="docutils literal notranslate"><span class="pre">fit()</span></code>, the models will build an appropriate <code class="docutils literal notranslate"><span class="pre">darts.utils.data.TrainingDataset</span></code>, which specifies how to slice the data to obtain training samples. If you want to control this slicing yourself, you can instantiate your own <code class="docutils literal notranslate"><span class="pre">TrainingDataset</span></code> and call <code class="docutils literal notranslate"><span class="pre">model.fit_from_dataset()</span></code> instead of <code class="docutils literal notranslate"><span class="pre">fit()</span></code>. By default, most models (though not all) will build <em>sequential</em> datasets, which basically means that all sub-slices of length <code class="docutils literal notranslate"><span class="pre">input_chunk_length</span> <span class="pre">+</span> <span class="pre">output_chunk_length</span></code> in the provided series will be used for training.</p>
<p>So during training, the torch models will go through the training data in sequences (see Figure 3). Using information from the <strong>input chunk</strong> and <strong>output chunk</strong>, the model predicts the future target on the output chunk. The training loss is evaluated between the predicted future target and the actual target value on the output chunk. The model trains itself by minimizing the loss over all sequences.</p>
<a class="reference external image-reference" href="./images/covariates/seq_covs_1.png"><img alt="figure5" src="../_images/seq_covs_1.png" /></a>
<p><strong>Figure 3: Prediction and loss evaluation in a single sequence</strong></p>
<p>After having completed computations on the first sequence, the model moves to the next one and performs the same training steps. <em>The starting point of each sequence is selected randomly from the sequential dataset</em>. Figure 4 shows how this would look like if by pure chance the second sequence started one time step (day) after the first.</p>
<p>This sequence-to-sequence process is repeated until all 365 days were covered.</p>
<p>Side note: Having “long” <code class="docutils literal notranslate"><span class="pre">target</span></code> series can result in a very large number of training sequences / samples. You can set an upper bound for the number of sequences / samples per <code class="docutils literal notranslate"><span class="pre">target</span></code> that the model should be trained on with <code class="docutils literal notranslate"><span class="pre">fit()</span></code>-parameter <code class="docutils literal notranslate"><span class="pre">max_samples_per_ts</span></code>. This will take the most recent sequences for every <code class="docutils literal notranslate"><span class="pre">target</span></code> series (sequences closest to <code class="docutils literal notranslate"><span class="pre">target</span></code> end).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># fit only on the 10 &quot;most recent&quot; sequences</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">max_samples_per_ts</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference external image-reference" href="./images/covariates/sequential_training.png"><img alt="figure6" src="../_images/sequential_training.png" /></a>
<p><strong>Figure 4: Sequence-to-sequence: Move to next sequence and repeat training steps</strong></p>
<section id="training-with-a-validation-dataset">
<h3>2.1.1. Training with a validation dataset<a class="headerlink" href="#training-with-a-validation-dataset" title="Permalink to this headline">¶</a></h3>
<p>You can also train your models with a validation dataset:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># create train and validation sets</span>
<span class="n">ice_cream_sales_train</span><span class="p">,</span> <span class="n">ice_cream_sales_val</span> <span class="o">=</span> <span class="n">ice_cream_sales</span><span class="o">.</span><span class="n">split_after</span><span class="p">(</span><span class="n">training_cutoff</span><span class="p">)</span>

<span class="c1"># train with validation set</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">ice_cream_sales_train</span><span class="p">,</span>
          <span class="n">past_covariates</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
          <span class="n">future_covariates</span><span class="o">=</span><span class="n">weekday</span><span class="p">,</span>
          <span class="n">val_series</span><span class="o">=</span><span class="n">ice_cream_sales_val</span><span class="p">,</span>
          <span class="n">val_past_covariates</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
          <span class="n">val_future_covariates</span><span class="o">=</span><span class="n">weekday</span><span class="p">)</span>
</pre></div>
</div>
<p>If you split your data, you have to define a <code class="docutils literal notranslate"><span class="pre">training_cutoff</span></code> (a date or fraction at which to split the dataset) so that both the train and validation datasets satisfy the minimum length requirements
from <a class="reference external" href="#14-required-target-time-spans-for-training-validation-and-prediction">section 1.4.</a></p>
<p>Instead of splitting by time, you can also use another subset of time series as validation set.</p>
<p>The model trains itself the same way as before but additionally evaluates the loss on the validation dataset. If you want to keep track of the best performing model on the validation set, you have to enable checkpoint saving as shown next.</p>
</section>
<section id="saving-and-loading-model-states">
<h3>2.1.2. Saving and Loading Model States<a class="headerlink" href="#saving-and-loading-model-states" title="Permalink to this headline">¶</a></h3>
<p>Per default, the models don’t automatically save any checkpoints. If you want to keep track of the best performing model on the validation set and the latest 5 epochs, you have to enable checkpoint saving at model creation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">SomeTorchForecastingModel</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;MyModel&#39;</span><span class="p">,</span> <span class="n">save_checkpoints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># checkpoints are saved automatically</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># load the model state that performed best on validation set</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">load_from_checkpoint</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;MyModel&#39;</span><span class="p">,</span> <span class="n">best</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also save or load manually:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
<span class="n">loaded_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
</pre></div>
</div>
<p>/!Warning /!At this stage of Darts development, we are not (yet) ensuring backward compatibility, so it might not always be possible to load a model saved by an older version of the library.</p>
</section>
</section>
<section id="forecast-prediction">
<h2>2.2. Forecast/Prediction<a class="headerlink" href="#forecast-prediction" title="Permalink to this headline">¶</a></h2>
<p>After having trained the model, we want to predict the future ice-cream sales for any number of days after our 365 days
training data.</p>
<p>The actual prediction works very similar to how we trained the data on sequences. Depending on the number of days we
want to predict - the forecast horizon <code class="docutils literal notranslate"><span class="pre">n</span></code> - we distinguish between two cases:</p>
<ul>
<li><p>If <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&lt;=</span> <span class="pre">output_chunk_length</span></code>: we can predict <code class="docutils literal notranslate"><span class="pre">n</span></code> in one go (using one “internal model call”)</p>
<ul class="simple">
<li><p>in our example: predict the next day’s ice-cream sales (<code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">=</span> <span class="pre">1</span></code>)</p></li>
</ul>
</li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&gt;</span> <span class="pre">output_chunk_length</span></code>: we must predict <code class="docutils literal notranslate"><span class="pre">n</span></code> by calling the internal model multiple times. Each call outputs <code class="docutils literal notranslate"><span class="pre">output_chunk_length</span></code> prediction points. We go through as many calls as needed until we get to the final <code class="docutils literal notranslate"><span class="pre">n</span></code> prediction points, in an auto-regressive fashion.</p>
<ul class="simple">
<li><p>in our example: predict ice-cream sales for the next 3 days at once (<code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">=</span> <span class="pre">3</span></code>)</p></li>
</ul>
<p>To do this we have to supply additional <code class="docutils literal notranslate"><span class="pre">past_covariates</span></code> for the next <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">-</span> <span class="pre">output_chunk_length</span> <span class="pre">=</span> <span class="pre">2</span></code> time steps (days) after the end of our 365 days training data. Unfortunately, we do not have measured <code class="docutils literal notranslate"><span class="pre">temperture</span></code> for the future. But let’s assume we have access to temperature forecasts for the next 2 days. We can just append them to <code class="docutils literal notranslate"><span class="pre">temperature</span></code> and the prediction will work!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">temperature_forecast</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                           <span class="n">series</span><span class="o">=</span><span class="n">ice_cream_sales_train</span><span class="p">,</span>
                           <span class="n">past_covariates</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                           <span class="n">future_covariates</span><span class="o">=</span><span class="n">weekday</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference external image-reference" href="./images/covariates/prediction_once.png"><img alt="figure7" src="../_images/prediction_once.png" /></a>
<p><a href="#id3"><span class="problematic" id="id4">**</span></a>Figure 5: Forecast with a single sequence for <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&lt;=</span> <span class="pre">output_chunk_length</span></code>**</p>
<a class="reference external image-reference" href="./images/covariates/prediction_multi.png"><img alt="figure8" src="../_images/prediction_multi.png" /></a>
<p><a href="#id5"><span class="problematic" id="id6">**</span></a>Figure 6: Auto-regressive forecast for <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&gt;</span> <span class="pre">output_chunk_length</span></code>**</p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="../userguide.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">User Guide</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="performance.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Neural Networks Performance Recommendations</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2020 - 2022, Unit8 SA (Apache 2.0 License).<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.2.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>